<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover - SkillSwap</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <button class="top-bar-btn">Copy</button>
            <button class="top-bar-btn">Publish</button>
        </div>
        <div class="top-bar-right">
            <div class="notification-bell">
                üîî
                <span class="notification-badge">3</span>
            </div>
            <div class="user-avatar-dropdown">
                <div class="avatar-circle"></div>
                <span>‚ñº</span>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üéì</span>
                <span class="logo-text">SkillSwap</span>
            </div>
            <nav class="main-nav">
                <a href="/discover.html" class="active">Discover</a>
                <a href="/matches.html">Matches</a>
                <a href="/messages.html">Messages</a>
                <a href="/profile.html">Profile</a>
                <a href="/login.html" id="login-link" style="display: none;">Login</a>
                <a href="#" id="logout-link" style="display: none;">Logout</a>
            </nav>
        </div>
    </header>

    <!-- Main Content - Three Column Layout -->
    <main class="discover-main">
        <!-- Left Sidebar - Filters and Stats -->
        <aside class="left-sidebar">
            <div class="filter-section">
                <h3>Year</h3>
                <div class="filter-pills">
                    <button class="filter-pill" data-year="Freshman">Freshman</button>
                    <button class="filter-pill" data-year="Sophomore">Sophomore</button>
                    <button class="filter-pill" data-year="Junior">Junior</button>
                    <button class="filter-pill" data-year="Senior">Senior</button>
                </div>
            </div>

            <div class="filter-section">
                <h3>Interests</h3>
                <div class="filter-pills">
                    <button class="filter-pill" data-interest="Tech">
                        <span class="icon">üíª</span> Tech
                    </button>
                    <button class="filter-pill" data-interest="Art">
                        <span class="icon">üé®</span> Art
                    </button>
                    <button class="filter-pill" data-interest="Music">
                        <span class="icon">üéµ</span> Music
                    </button>
                    <button class="filter-pill" data-interest="Sports">
                        <span class="icon">üèÄ</span> Sports
                    </button>
                </div>
            </div>

            <div class="filter-section">
                <h3>Location</h3>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="filter-by-location" onchange="toggleLocationFilter()">
                    <span>Show nearby users only</span>
                </label>
                <div id="location-filter-options" style="display: none; margin-top: 0.5rem;">
                    <label for="max-distance" style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem;">Max distance (km):</label>
                    <input type="range" id="max-distance" min="5" max="200" value="50" step="5" 
                           oninput="updateDistanceLabel(this.value)" style="width: 100%;">
                    <div id="distance-label" style="text-align: center; font-size: 0.9rem; color: #667eea; margin-top: 0.25rem;">50 km</div>
                </div>
            </div>

            <div class="stats-section">
                <h3>YOUR STATS</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Matches</span>
                    <span class="stat-value" id="total-matches">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Active Chats</span>
                    <span class="stat-value" id="active-chats">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Profile Views</span>
                    <span class="stat-value" id="profile-views">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Skill Swaps</span>
                    <span class="stat-value" id="skill-swaps">0</span>
                </div>
            </div>
        </aside>

        <!-- Center - Profile Card -->
        <section class="center-content">
            <div class="profile-card-wrapper">
                <div id="user-card-container" class="profile-card">
                    <div class="loading">Loading users...</div>
                </div>
                
                <!-- Pagination Dots -->
                <div class="pagination-dots" id="pagination-dots" style="display: none;">
                    <span class="dot active"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                
                <!-- Swipe Buttons -->
                <div class="swipe-buttons-container" id="swipe-buttons-container" style="display: none;">
                    <button class="swipe-btn swipe-btn-pass" onclick="swipeLeft()">
                        <span class="swipe-icon">‚úï</span>
                        <span class="swipe-text">PASS</span>
                    </button>
                    <button class="swipe-btn swipe-btn-like" onclick="swipeRight()">
                        <span class="swipe-icon">‚ù§Ô∏è</span>
                        <span class="swipe-text">LIKE</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Right Sidebar - Notifications and Matches -->
        <aside class="right-sidebar">
            <div class="notification-card">
                <div class="notification-avatar"></div>
                <div class="notification-content">
                    <div class="notification-header">
                        <strong>James Wilson</strong>
                        <span class="notification-dot"></span>
                    </div>
                    <p class="notification-text">Thanks for the tips!</p>
                </div>
            </div>

            <button class="view-matches-btn" onclick="window.location.href='/matches.html'">
                View All Matches
            </button>
        </aside>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        let currentUsers = [];
        let currentIndex = 0;
        let currentUserId = getCurrentUserId();
        let swipedUserIds = new Set();
        let activeFilters = {
            years: [],
            interests: [],
            locationEnabled: false,
            maxDistance: 50 // kilometers
        };

        // Load stats on page load
        async function loadStats() {
            try {
                const [matches, swipes] = await Promise.all([
                    fetch('/api/matches').then(r => r.json()),
                    fetch(`/api/swipes/user/${currentUserId}`).then(r => r.json())
                ]);

                document.getElementById('total-matches').textContent = matches.length;
                document.getElementById('active-chats').textContent = matches.length; // Simplified
                document.getElementById('profile-views').textContent = '0'; // TODO: Implement
                document.getElementById('skill-swaps').textContent = '0'; // TODO: Implement
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load users excluding already swiped ones
        async function loadUsers() {
            try {
                // Get all users
                const usersResponse = await fetch('/api/users');
                const allUsers = await usersResponse.json();

                // Get all profiles
                const profilesResponse = await fetch('/api/profiles');
                const allProfiles = await profilesResponse.json();

                // Get current user
                const currentUser = allUsers.find(u => u.userId === currentUserId);
                const currentUserProfile = allProfiles.find(p => p.user?.userId === currentUserId);

                // Get current user's location (prefer User table, fallback to Profile)
                // IMPORTANT: Only use location if showLocation is true (privacy setting)
                console.log('=== LOADING USERS FOR DISCOVER PAGE ===');
                console.log('Current User ID:', currentUserId);
                console.log('Current User object:', currentUser);
                console.log('Current User Profile object:', currentUserProfile);
                
                let currentLat = null, currentLon = null;
                let currentUserShowLocation = false;
                
                if (currentUser && currentUser.latitude && currentUser.longitude && currentUser.showLocation === true) {
                    currentLat = currentUser.latitude;
                    currentLon = currentUser.longitude;
                    currentUserShowLocation = true;
                    console.log('‚úÖ Using User table location (showLocation enabled):', { 
                        latitude: currentLat, 
                        longitude: currentLon,
                        showLocation: currentUser.showLocation,
                        source: 'User table'
                    });
                } else if (currentUserProfile && currentUserProfile.latitude && currentUserProfile.longitude && currentUserProfile.showLocation === true) {
                    currentLat = currentUserProfile.latitude;
                    currentLon = currentUserProfile.longitude;
                    currentUserShowLocation = true;
                    console.log('‚úÖ Using Profile table location (showLocation enabled):', { 
                        latitude: currentLat, 
                        longitude: currentLon,
                        showLocation: currentUserProfile.showLocation,
                        source: 'Profile table'
                    });
                } else {
                    console.log('‚ö†Ô∏è Current user location not available or showLocation is disabled');
                    console.log('User table has location:', currentUser?.latitude && currentUser?.longitude);
                    console.log('User table showLocation:', currentUser?.showLocation);
                    console.log('Profile table has location:', currentUserProfile?.latitude && currentUserProfile?.longitude);
                    console.log('Profile table showLocation:', currentUserProfile?.showLocation);
                    console.log('üìç Distance will NOT be calculated or displayed (privacy: showLocation is false)');
                }
                
                // Store current user's showLocation status globally for use in displayCurrentUser
                window.currentUserShowLocation = currentUserShowLocation;

                // Get swiped users
                const swipesResponse = await fetch(`/api/swipes/user/${currentUserId}`);
                const swipes = await swipesResponse.json();
                
                swipedUserIds.clear();
                swipes.forEach(swipe => {
                    swipedUserIds.add(swipe.swipee.userId);
                });

                // Filter out current user and already swiped users
                let filteredUsers = allUsers.filter(user => 
                    user.userId !== currentUserId && !swipedUserIds.has(user.userId)
                );

                // Apply location filter if enabled
                if (activeFilters.locationEnabled && currentLat && currentLon) {
                    filteredUsers = filteredUsers.filter(user => {
                        // Check User table first, then Profile table
                        let userLat = null, userLon = null, showLocation = false;
                        
                        if (user.latitude && user.longitude && user.showLocation) {
                            userLat = user.latitude;
                            userLon = user.longitude;
                            showLocation = true;
                            console.log(`User ${user.userId} location from User table:`, { 
                                latitude: userLat, 
                                longitude: userLon,
                                showLocation: user.showLocation
                            });
                        } else {
                            const userProfile = allProfiles.find(p => p.user?.userId === user.userId);
                            if (userProfile && userProfile.showLocation && 
                                userProfile.latitude && userProfile.longitude) {
                                userLat = userProfile.latitude;
                                userLon = userProfile.longitude;
                                showLocation = true;
                                console.log(`User ${user.userId} location from Profile table:`, { 
                                    latitude: userLat, 
                                    longitude: userLon,
                                    showLocation: userProfile.showLocation
                                });
                            } else {
                                console.log(`User ${user.userId} has no location or showLocation is false`);
                            }
                        }
                        
                        if (!showLocation || !userLat || !userLon) {
                            return false;
                        }
                        
                        // Calculate distance
                        console.log(`=== DISTANCE CALCULATION for User ${user.userId} ===`);
                        console.log('Current user location:', { latitude: currentLat, longitude: currentLon });
                        console.log('Other user location:', { latitude: userLat, longitude: userLon });
                        const distance = calculateDistance(currentLat, currentLon, userLat, userLon);
                        console.log('Calculated distance:', distance.toFixed(2), 'km');
                        console.log('Max distance filter:', activeFilters.maxDistance, 'km');
                        console.log('Within range:', distance <= activeFilters.maxDistance);
                        
                        // Store distance in user object for display
                        user._distance = distance;
                        
                        return distance <= activeFilters.maxDistance;
                    });
                } else {
                    // Calculate and store distance for all users (for display purposes)
                    // ONLY if both current user and other user have showLocation enabled
                    if (currentLat && currentLon && currentUserShowLocation) {
                        filteredUsers.forEach(user => {
                            let userLat = null, userLon = null;
                            let otherUserShowLocation = false;
                            
                            // Check User table first
                            if (user.latitude && user.longitude && user.showLocation === true) {
                                userLat = user.latitude;
                                userLon = user.longitude;
                                otherUserShowLocation = true;
                            } else {
                                // Check Profile table
                                const userProfile = allProfiles.find(p => p.user?.userId === user.userId);
                                if (userProfile && userProfile.latitude && userProfile.longitude && userProfile.showLocation === true) {
                                    userLat = userProfile.latitude;
                                    userLon = userProfile.longitude;
                                    otherUserShowLocation = true;
                                }
                            }
                            
                            // Only calculate distance if BOTH users have showLocation enabled
                            if (userLat && userLon && otherUserShowLocation) {
                                user._distance = calculateDistance(currentLat, currentLon, userLat, userLon);
                                console.log(`Distance calculated for user ${user.userId} (both users have showLocation enabled):`, user._distance.toFixed(2), 'km');
                            } else {
                                // Clear any existing distance if privacy settings don't allow it
                                user._distance = undefined;
                                if (userLat && userLon) {
                                    console.log(`Distance NOT calculated for user ${user.userId} (showLocation is false - privacy protected)`);
                                }
                            }
                        });
                    } else {
                        // Clear distances for all users if current user doesn't have showLocation enabled
                        filteredUsers.forEach(user => {
                            user._distance = undefined;
                        });
                        if (!currentUserShowLocation) {
                            console.log('üìç Current user has showLocation disabled - no distances will be calculated or displayed');
                        }
                    }
                }

                // Apply year filter if any selected
                if (activeFilters.years.length > 0) {
                    filteredUsers = filteredUsers.filter(user => {
                        const userProfile = allProfiles.find(p => p.user?.userId === user.userId);
                        return userProfile && activeFilters.years.includes(userProfile.year);
                    });
                }

                // Apply interest filter if any selected
                if (activeFilters.interests.length > 0) {
                    // TODO: Filter by interests when interest data is available
                }

                currentUsers = filteredUsers;
                currentIndex = 0;
                displayCurrentUser();
            } catch (error) {
                document.getElementById('user-card-container').innerHTML = 
                    '<div class="error">Error loading users: ' + error.message + '</div>';
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        function toggleLocationFilter() {
            const checkbox = document.getElementById('filter-by-location');
            const optionsDiv = document.getElementById('location-filter-options');
            activeFilters.locationEnabled = checkbox.checked;
            optionsDiv.style.display = checkbox.checked ? 'block' : 'none';
            loadUsers();
        }
        
        function updateDistanceLabel(value) {
            document.getElementById('distance-label').textContent = value + ' km';
            activeFilters.maxDistance = parseInt(value);
            if (activeFilters.locationEnabled) {
                loadUsers();
            }
        }

        function displayCurrentUser() {
            const container = document.getElementById('user-card-container');
            
            if (currentIndex >= currentUsers.length) {
                container.innerHTML = '<div class="empty-state">No more users to show! Check back later for new profiles.</div>';
                document.getElementById('pagination-dots').style.display = 'none';
                document.getElementById('swipe-buttons-container').style.display = 'none';
                return;
            }

            const user = currentUsers[currentIndex];
            const age = user.dateOfBirth ? new Date().getFullYear() - new Date(user.dateOfBirth).getFullYear() : '';
            
            // Get user location (prefer User table, fallback to Profile)
            const userLocation = user.latitude && user.longitude ? 
                (user.showLocation ? 'Location visible' : '') : '';
            
            // Load profile data if available
            loadUserProfile(user.userId).then(profile => {
                // Determine location display
                let locationDisplay = profile?.location || 'Location not set';
                let locationStatus = '';
                
                if (user.showLocation && user.latitude && user.longitude) {
                    locationStatus = '<span style="color: #28a745; margin-left: 0.5rem;">‚úì Location visible</span>';
                } else if (profile?.showLocation && profile?.latitude && profile?.longitude) {
                    locationStatus = '<span style="color: #28a745; margin-left: 0.5rem;">‚úì Location visible</span>';
                }
                
                // Display distance ONLY if both users have showLocation enabled
                // Check if current user has showLocation enabled (from global variable set in loadUsers)
                const currentUserShowLocation = window.currentUserShowLocation || false;
                
                // Check if other user has showLocation enabled
                let otherUserShowLocation = false;
                if (user.showLocation === true && user.latitude && user.longitude) {
                    otherUserShowLocation = true;
                } else if (profile?.showLocation === true && profile?.latitude && profile?.longitude) {
                    otherUserShowLocation = true;
                }
                
                // Only display distance if BOTH users have opted to share location
                // The distance should only be calculated if both users have showLocation enabled
                // (this is handled in loadUsers function, but we double-check here for privacy)
                let distanceDisplay = '';
                if (user._distance !== undefined && currentUserShowLocation && otherUserShowLocation) {
                    // Both users have showLocation enabled, safe to display distance
                    const distance = user._distance;
                    let distanceText = '';
                    if (distance < 1) {
                        distanceText = Math.round(distance * 1000) + ' m away';
                    } else if (distance < 10) {
                        distanceText = distance.toFixed(1) + ' km away';
                    } else {
                        distanceText = Math.round(distance) + ' km away';
                    }
                    distanceDisplay = `<div class="detail-item" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                        <span class="detail-icon">üìè</span>
                        <span style="font-weight: 600; color: #667eea;">${distanceText}</span>
                    </div>`;
                } else if (user._distance !== undefined) {
                    // Distance was calculated but shouldn't be shown due to privacy
                    console.log(`üîí Distance not displayed for user ${user.userId} - privacy check failed:`);
                    console.log(`   Current user showLocation: ${currentUserShowLocation}`);
                    console.log(`   Other user showLocation: ${otherUserShowLocation}`);
                    // Clear the distance to ensure it's not displayed
                    user._distance = undefined;
                }
                
                container.innerHTML = `
                    <button class="view-full-profile-btn" onclick="viewFullProfile(${user.userId})">View Full Profile ></button>
                    <div class="profile-image-placeholder">
                        <div class="avatar-large"></div>
                    </div>
                    <div class="profile-info">
                        <h2 class="profile-name">${user.firstName || ''} ${user.lastName || ''}${age ? ', ' + age : ''}</h2>
                        <div class="profile-details">
                            <div class="detail-item">
                                <span class="detail-icon">üíª</span>
                                <span>${profile?.major || 'Not specified'}, ${profile?.year || 'Not specified'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üéì</span>
                                <span>${user.university || 'State University'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üìç</span>
                                <span>${locationDisplay}</span>
                                ${locationStatus}
                            </div>
                            ${distanceDisplay}
                        </div>
                        <div class="about-section">
                            <h3>ABOUT</h3>
                            <p>${profile?.bio || 'No bio available yet.'}</p>
                        </div>
                    </div>
                `;
                document.getElementById('pagination-dots').style.display = 'flex';
                document.getElementById('swipe-buttons-container').style.display = 'flex';
            });
        }

        async function loadUserProfile(userId) {
            try {
                const profiles = await fetch('/api/profiles').then(r => r.json());
                return profiles.find(p => p.user?.userId === userId);
            } catch (error) {
                return null;
            }
        }

        async function swipeLeft() {
            if (currentIndex >= currentUsers.length) return;
            
            const currentUser = currentUsers[currentIndex];
            await performSwipe(currentUser.userId, false);
            currentIndex++;
            displayCurrentUser();
        }

        async function swipeRight() {
            if (currentIndex >= currentUsers.length) return;
            
            const currentUser = currentUsers[currentIndex];
            await performSwipe(currentUser.userId, true);
            currentIndex++;
            displayCurrentUser();
        }

        async function performSwipe(swipeeId, isLike) {
            try {
                const swipeData = {
                    swiper: { userId: currentUserId },
                    swipee: { userId: swipeeId },
                    isLike: isLike
                };

                const response = await fetch('/api/swipes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(swipeData)
                });

                if (response.ok) {
                    const swipe = await response.json();
                    swipedUserIds.add(swipeeId);
                    
                    // If it was a like and we got a match, show notification
                    if (isLike) {
                        // Check if match was created (backend handles this)
                        setTimeout(() => loadStats(), 500); // Refresh stats
                    }
                } else {
                    console.error('Swipe failed:', await response.text());
                }
            } catch (error) {
                console.error('Error performing swipe:', error);
            }
        }

        function viewFullProfile(userId) {
            // Navigate to profile page with userId query parameter
            window.location.href = `/view-profile.html?userId=${userId}`;
        }

        // Filter pill click handlers
        document.querySelectorAll('.filter-pill[data-year]').forEach(pill => {
            pill.addEventListener('click', function() {
                this.classList.toggle('active');
                const year = this.dataset.year;
                if (this.classList.contains('active')) {
                    activeFilters.years.push(year);
                } else {
                    activeFilters.years = activeFilters.years.filter(y => y !== year);
                }
                loadUsers();
            });
        });

        document.querySelectorAll('.filter-pill[data-interest]').forEach(pill => {
            pill.addEventListener('click', function() {
                this.classList.toggle('active');
                const interest = this.dataset.interest;
                if (this.classList.contains('active')) {
                    activeFilters.interests.push(interest);
                } else {
                    activeFilters.interests = activeFilters.interests.filter(i => i !== interest);
                }
                loadUsers();
            });
        });

        // Keyboard shortcuts for swiping
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                swipeLeft();
            } else if (e.key === 'ArrowRight') {
                swipeRight();
            }
        });

        // Load on page load
        loadStats();
        loadUsers();
    </script>
</body>
</html>

