<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - SkillSwap</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <button class="top-bar-btn">Copy</button>
            <button class="top-bar-btn">Publish</button>
        </div>
        <div class="top-bar-right">
            <div class="notification-bell">
                üîî
                <span class="notification-badge">3</span>
            </div>
            <div class="user-avatar-dropdown">
                <div class="avatar-circle"></div>
                <span>‚ñº</span>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üéì</span>
                <span class="logo-text">SkillSwap</span>
            </div>
            <nav class="main-nav">
                <a href="/discover.html">Discover</a>
                <a href="/matches.html">Matches</a>
                <a href="/messages.html">Messages</a>
                <a href="/profile.html" class="active">Profile</a>
                <a href="/login.html" id="login-link" style="display: none;">Login</a>
                <a href="#" id="logout-link" style="display: none;">Logout</a>
            </nav>
        </div>
    </header>

    <!-- Main Content - Full Width -->
    <main style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 style="margin: 0; font-size: 2rem;">My Profile</h1>
            <button class="btn btn-primary" onclick="window.location.href='/view-profile.html'">
                üëÅÔ∏è View My Profile
            </button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Left Column -->
            <div>
                <!-- Profile Photo Upload -->
                <div class="profile-section-card">
                    <h3>Profile Photo</h3>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div style="width: 100px; height: 100px; border-radius: 12px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            <img id="profile-photo-preview" src="" alt="Profile preview" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <div id="profile-photo-placeholder" style="color: #999;">No photo</div>
                        </div>
                        <div style="flex: 1;">
                            <input type="file" id="profile-photo-input" accept="image/*" style="margin-bottom: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                                <input type="checkbox" id="photo-primary" checked> Set as primary
                            </label>
                            <button class="btn btn-primary" style="margin-top: 0.5rem;" onclick="uploadProfilePhoto()">Upload Photo</button>
                            <div id="photo-upload-status" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;"></div>
                        </div>
                    </div>
                    <div id="profile-photo-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem;"></div>
                </div>

                <!-- Basic Information -->
                <div class="profile-section-card">
                    <h3>Basic Information</h3>
                    <form id="profile-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="firstName">First Name</label>
                                <input type="text" id="firstName" name="firstName" placeholder="Enter your first name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="lastName">Last Name</label>
                                <input type="text" id="lastName" name="lastName" placeholder="Enter your last name" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="bio">Bio</label>
                            <textarea id="bio" name="bio" rows="4" placeholder="Tell us about yourself, your interests, and what you're looking for..."></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="major">Major</label>
                                <input type="text" id="major" name="major" placeholder="e.g., Computer Science">
                            </div>
                            
                            <div class="form-group">
                                <label for="year">Year</label>
                                <select id="year" name="year">
                                    <option value="">Select Year</option>
                                    <option value="Freshman">Freshman</option>
                                    <option value="Sophomore">Sophomore</option>
                                    <option value="Junior">Junior</option>
                                    <option value="Senior">Senior</option>
                                    <option value="Graduate">Graduate</option>
                                    <option value="Faculty">Faculty</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="location">Location</label>
                            <div style="position: relative;">
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="text" id="location" name="location" placeholder="e.g., Atlanta, GA or New York, NY" 
                                           style="flex: 1;" autocomplete="off" oninput="handleLocationInput()" 
                                           onfocus="handleLocationFocus()" onblur="handleLocationBlur()"
                                           onkeydown="handleLocationKeyDown(event)">
                                    <button type="button" class="btn btn-secondary" onclick="usePreciseLocation()" style="white-space: nowrap;">
                                        üìç Use My Location
                                    </button>
                                </div>
                                <div id="location-suggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; 
                                    background: white; border: 1px solid #ddd; border-radius: 4px; margin-top: 2px; 
                                    max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                </div>
                            </div>
                            <div style="margin-top: 0.25rem; font-size: 0.85rem; color: #666;">
                                üí° Tip: Start typing to see city suggestions
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="showLocation" name="showLocation">
                                    <span>Show my location for matching (allows others to find me by location)</span>
                                </label>
                            </div>
                            <div id="location-status" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;"></div>
                        </div>

                        <div class="form-group">
                            <label for="career-goals">Career Goals</label>
                            <textarea id="career-goals" name="career-goals" rows="3" placeholder="What are your career aspirations?"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="availability">Availability</label>
                            <select id="availability" name="availability">
                                <option value="">Select Availability</option>
                                <option value="Very Available">Very Available (10+ hours/week)</option>
                                <option value="Moderately Available">Moderately Available (5-10 hours/week)</option>
                                <option value="Limited Availability">Limited Availability (1-5 hours/week)</option>
                                <option value="On Demand">On Demand (As needed)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="career">Career/Job Title</label>
                            <input type="text" id="career" name="career" placeholder="e.g., Software Engineer, Research Assistant, etc.">
                        </div>

                        <div class="form-group">
                            <label for="career-experience">Career Experience</label>
                            <textarea id="career-experience" name="career-experience" rows="4" placeholder="Describe your work experience, internships, projects, etc."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="research-publications">Research & Publications</label>
                            <textarea id="research-publications" name="research-publications" rows="4" placeholder="List your research projects, publications, papers, etc."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="awards">Awards & Achievements</label>
                            <textarea id="awards" name="awards" rows="4" placeholder="List any awards, honors, certifications, etc."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Save Profile</button>
                        <div id="profile-message" style="margin-top: 1rem;"></div>
                    </form>
                </div>

                <!-- Languages -->
                <div class="profile-section-card">
                    <h3>Languages</h3>
                    <div id="languages-list"></div>
                    <button class="btn btn-secondary" onclick="showAddLanguageForm()" style="margin-top: 1rem; width: 100%;">Add Language</button>
                    <div id="add-language-form" style="display: none; margin-top: 1rem;">
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem;">
                            <select id="new-language-name" style="padding: 0.5rem;">
                                <option value="">Select Language</option>
                                <option value="English">English</option>
                                <option value="Spanish">Spanish</option>
                                <option value="French">French</option>
                                <option value="German">German</option>
                                <option value="Chinese">Chinese</option>
                                <option value="Japanese">Japanese</option>
                                <option value="Korean">Korean</option>
                                <option value="Arabic">Arabic</option>
                                <option value="Portuguese">Portuguese</option>
                                <option value="Italian">Italian</option>
                            </select>
                            <select id="new-language-level" style="padding: 0.5rem;">
                                <option value="Native">Native</option>
                                <option value="Fluent">Fluent</option>
                                <option value="Conversational">Conversational</option>
                                <option value="Basic">Basic</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn btn-primary" onclick="addLanguage()" style="flex: 1;">Add</button>
                            <button class="btn btn-secondary" onclick="hideAddLanguageForm()" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- Skills -->
                <div class="profile-section-card">
                    <h3>My Skills</h3>
                    <div id="skills-list"></div>
                    <button class="btn btn-secondary" onclick="showAddSkillForm()" style="margin-top: 1rem; width: 100%;">Add Skill</button>
                    <div id="add-skill-form" style="display: none; margin-top: 1rem;">
                        <input type="text" id="new-skill-name" placeholder="Skill name" style="padding: 0.5rem; width: 100%; margin-bottom: 0.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <select id="new-skill-level" style="padding: 0.5rem;">
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                                <option value="Expert">Expert</option>
                            </select>
                            <select id="new-skill-category" style="padding: 0.5rem;">
                                <option value="">Category (optional)</option>
                                <option value="Technical">Technical</option>
                                <option value="Creative">Creative</option>
                                <option value="Business">Business</option>
                                <option value="Language">Language</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="offering"> Offering
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="seeking"> Seeking
                            </label>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="addSkill()" style="flex: 1;">Add</button>
                            <button class="btn btn-secondary" onclick="hideAddSkillForm()" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Interests -->
                <div class="profile-section-card">
                    <h3>Interests & Hobbies</h3>
                    <div id="interests-list"></div>
                    <button class="btn btn-secondary" onclick="showAddInterestForm()" style="margin-top: 1rem; width: 100%;">Add Interest</button>
                    <div id="add-interest-form" style="display: none; margin-top: 1rem;">
                        <input type="text" id="new-interest-name" placeholder="Interest name" style="padding: 0.5rem; width: 100%; margin-bottom: 0.5rem;">
                        <select id="new-interest-category" style="padding: 0.5rem; width: 100%; margin-bottom: 0.5rem;">
                            <option value="">Category (optional)</option>
                            <option value="Technology">Technology</option>
                            <option value="Arts">Arts</option>
                            <option value="Sports">Sports</option>
                            <option value="Music">Music</option>
                            <option value="Travel">Travel</option>
                            <option value="Food">Food</option>
                            <option value="Gaming">Gaming</option>
                            <option value="Reading">Reading</option>
                            <option value="Other">Other</option>
                        </select>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="addInterest()" style="flex: 1;">Add</button>
                            <button class="btn btn-secondary" onclick="hideAddInterestForm()" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Organizations -->
                <div class="profile-section-card">
                    <h3>Organizations & Clubs</h3>
                    <div id="organizations-list"></div>
                    <button class="btn btn-secondary" onclick="showAddOrgForm()" style="margin-top: 1rem; width: 100%;">Add Organization</button>
                    <div id="add-org-form" style="display: none; margin-top: 1rem;">
                        <input type="text" id="new-org-name" placeholder="Organization name" style="padding: 0.5rem; width: 100%; margin-bottom: 0.5rem;">
                        <input type="text" id="new-org-role" placeholder="Your role (e.g., President, Member)" style="padding: 0.5rem; width: 100%; margin-bottom: 0.5rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="addOrganization()" style="flex: 1;">Add</button>
                            <button class="btn btn-secondary" onclick="hideAddOrgForm()" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Social Links -->
                <div class="profile-section-card">
                    <h3>Social Links (Optional)</h3>
                    <div class="form-group">
                        <label for="linkedin">LinkedIn</label>
                        <input type="url" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/yourprofile">
                    </div>
                    <div class="form-group">
                        <label for="github">GitHub</label>
                        <input type="url" id="github" name="github" placeholder="https://github.com/yourusername">
                    </div>
                    <div class="form-group">
                        <label for="portfolio">Portfolio Website</label>
                        <input type="url" id="portfolio" name="portfolio" placeholder="https://yourportfolio.com">
                    </div>
                    <button class="btn btn-secondary" onclick="saveSocialLinks()" style="width: 100%;">Save Links</button>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        let currentUserId = getCurrentUserId();
        let currentProfile = null;
        let currentPhotos = [];

        async function loadProfile() {
            try {
                const [users, profiles, userSkills, userInterests, userOrgs, userLanguages] = await Promise.all([
                    fetch('/api/users').then(r => r.json()),
                    fetch('/api/profiles').then(r => r.json()),
                    fetch('/api/user-skills').then(r => r.json()).catch(() => []),
                    fetch('/api/interests').then(r => r.json()).catch(() => []),
                    fetch('/api/organizations').then(r => r.json()).catch(() => []),
                    fetch('/api/languages').then(r => r.json()).catch(() => [])
                ]);

                const currentUser = users.find(u => u.userId === currentUserId);
                currentProfile = profiles.find(p => p.user?.userId === currentUserId);
                
                // Load user name
                if (currentUser) {
                    document.getElementById('firstName').value = currentUser.firstName || '';
                    document.getElementById('lastName').value = currentUser.lastName || '';
                }
                
                // Load profile data
                if (currentProfile) {
                    document.getElementById('bio').value = currentProfile.bio || '';
                    document.getElementById('major').value = currentProfile.major || '';
                    document.getElementById('year').value = currentProfile.year || '';
                    document.getElementById('location').value = currentProfile.location || '';
                    document.getElementById('showLocation').checked = currentProfile.showLocation || false;
                    document.getElementById('career-goals').value = currentProfile.careerGoals || '';
                    document.getElementById('availability').value = currentProfile.availability || '';
                    document.getElementById('linkedin').value = currentProfile.linkedin || '';
                    document.getElementById('github').value = currentProfile.github || '';
                    document.getElementById('portfolio').value = currentProfile.portfolio || '';
                    document.getElementById('career').value = currentProfile.career || '';
                    document.getElementById('career-experience').value = currentProfile.careerExperience || '';
                    document.getElementById('research-publications').value = currentProfile.researchPublications || '';
                    document.getElementById('awards').value = currentProfile.awards || '';
                    
                    // Update location status
                    updateLocationStatus(currentProfile);
                }

                // Load languages, skills, interests, organizations
                displayLanguages(userLanguages.filter(l => l.user?.userId === currentUserId));
                displaySkills(userSkills.filter(s => s.user?.userId === currentUserId));
                displayInterests(userInterests.filter(i => i.user?.userId === currentUserId));
                displayOrganizations(userOrgs.filter(o => o.user?.userId === currentUserId));

                await loadProfilePhotos();
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function displaySkills(skills) {
            const container = document.getElementById('skills-list');
            if (skills.length === 0) {
                container.innerHTML = '<p style="color: #666;">No skills added yet.</p>';
                return;
            }
            container.innerHTML = skills.map(skill => `
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 5px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${skill.skillName}</strong> - ${skill.skillLevel || 'Not specified'}
                        ${skill.offering ? '<span style="color: #28a745; margin-left: 0.5rem;">[Offering]</span>' : ''}
                        ${skill.seeking ? '<span style="color: #667eea; margin-left: 0.5rem;">[Seeking]</span>' : ''}
                    </div>
                    <button onclick="deleteSkill(${skill.skillId})" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 3px; cursor: pointer;">Delete</button>
                </div>
            `).join('');
        }

        function displayInterests(interests) {
            const container = document.getElementById('interests-list');
            if (interests.length === 0) {
                container.innerHTML = '<p style="color: #666;">No interests added yet.</p>';
                return;
            }
            container.innerHTML = interests.map(interest => `
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 5px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <div><strong>${interest.interestName}</strong>${interest.category ? ' - ' + interest.category : ''}</div>
                    <button onclick="deleteInterest(${interest.interestId})" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 3px; cursor: pointer;">Delete</button>
                </div>
            `).join('');
        }

        function displayOrganizations(orgs) {
            const container = document.getElementById('organizations-list');
            if (orgs.length === 0) {
                container.innerHTML = '<p style="color: #666;">No organizations added yet.</p>';
                return;
            }
            container.innerHTML = orgs.map(org => `
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 5px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <div><strong>${org.organizationName}</strong>${org.role ? ' - ' + org.role : ''}</div>
                    <button onclick="deleteOrganization(${org.orgId})" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 3px; cursor: pointer;">Delete</button>
                </div>
            `).join('');
        }

        async function loadProfilePhotos() {
            if (!currentProfile || !currentProfile.profileId) {
                currentPhotos = [];
                renderPhotoGallery();
                return;
            }
            try {
                const res = await fetch(`/api/photos/${currentProfile.profileId}`);
                if (!res.ok) throw new Error(`Failed to load photos (${res.status})`);
                currentPhotos = await res.json();
                renderPhotoGallery();
            } catch (error) {
                console.error('Error loading photos:', error);
                document.getElementById('photo-upload-status').textContent = 'Error loading photos.';
            }
        }

        function renderPhotoGallery() {
            const gallery = document.getElementById('profile-photo-gallery');
            const preview = document.getElementById('profile-photo-preview');
            const placeholder = document.getElementById('profile-photo-placeholder');

            if (!currentPhotos || currentPhotos.length === 0) {
                gallery.innerHTML = '<div style="color:#999;">No photos uploaded yet.</div>';
                preview.style.display = 'none';
                placeholder.style.display = 'block';
                return;
            }

            const primary = currentPhotos.find(p => p.isPrimary) || currentPhotos[0];
            if (primary && primary.photoUrl) {
                preview.src = primary.photoUrl;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            }

            gallery.innerHTML = currentPhotos.map(photo => `
                <div style="border:1px solid #eee; border-radius:8px; overflow:hidden; background:#fafafa;">
                    <img src="${photo.photoUrl}" alt="Profile photo" style="width:100%; height:80px; object-fit:cover;">
                    <div style="padding:0.35rem; font-size:0.8rem; color:${photo.isPrimary ? '#4c51bf' : '#666'};">
                        ${photo.isPrimary ? 'Primary' : 'Photo'}
                    </div>
                </div>
            `).join('');
        }

        async function uploadProfilePhoto() {
            const statusEl = document.getElementById('photo-upload-status');
            const fileInput = document.getElementById('profile-photo-input');
            const isPrimary = document.getElementById('photo-primary').checked;

            if (!currentProfile || !currentProfile.profileId) {
                statusEl.textContent = 'Save your profile first to upload photos.';
                return;
            }

            if (!fileInput.files || fileInput.files.length === 0) {
                statusEl.textContent = 'Please choose an image file.';
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('profileId', currentProfile.profileId);
            formData.append('isPrimary', isPrimary);

            statusEl.textContent = 'Uploading...';
            try {
                const res = await fetch('/api/photos/upload', {
                    method: 'POST',
                    body: formData
                });
                if (!res.ok) throw new Error(`Upload failed (${res.status})`);
                await loadProfilePhotos();
                statusEl.textContent = 'Photo uploaded successfully.';
                fileInput.value = '';
            } catch (error) {
                console.error('Upload error:', error);
                statusEl.textContent = 'Upload failed. Please try again.';
            }
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check if user is logged in
            if (!currentUserId || currentUserId === 1) {
                const currentUser = checkAuth();
                if (!currentUser) {
                    document.getElementById('profile-message').innerHTML = 
                        '<div class="error-message">Please log in to save your profile. <a href="/login.html">Login here</a></div>';
                    return;
                }
                currentUserId = currentUser.userId || currentUser.id;
            }
            
            let user;
            try {
                // Try to get user directly by ID first
                try {
                    const userResponse = await fetch(`/api/users/${currentUserId}`);
                    if (userResponse.ok) {
                        user = await userResponse.json();
                    } else {
                        // Fallback to getting all users
                        const usersResponse = await fetch('/api/users');
                        const users = await usersResponse.json();
                        user = users.find(u => u.userId === currentUserId);
                    }
                } catch (err) {
                    // Fallback to getting all users
                    const usersResponse = await fetch('/api/users');
                    const users = await usersResponse.json();
                    user = users.find(u => u.userId === currentUserId);
                }
                
                if (!user) {
                    document.getElementById('profile-message').innerHTML = 
                        '<div class="error-message">User not found. Please log in again. <a href="/login.html">Login here</a></div>';
                    return;
                }
            } catch (error) {
                document.getElementById('profile-message').innerHTML = 
                    '<div class="error-message">Error loading user: ' + error.message + '</div>';
                return;
            }
            
            // Update user name first
            const userData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value
            };

            try {
                // Update user information
                const userResponse = await fetch(`/api/users/${currentUserId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                if (!userResponse.ok) {
                    throw new Error('Failed to update user information');
                }

                // Update localStorage with new user data
                const updatedUser = await userResponse.json();
                setCurrentUser(updatedUser);
                
                // Update the user object for profile data
                user = updatedUser;

                // Show geocoding status if location is provided
                const locationValue = document.getElementById('location').value.trim();
                const statusDiv = document.getElementById('location-status');
                if (locationValue) {
                    statusDiv.innerHTML = '<span style="color: #667eea;">üìç Geocoding location...</span>';
                }

                // Update profile data
                const profileData = {
                    user: user,
                    bio: document.getElementById('bio').value,
                    major: document.getElementById('major').value,
                    year: document.getElementById('year').value,
                    location: locationValue,
                    showLocation: document.getElementById('showLocation').checked,
                    careerGoals: document.getElementById('career-goals').value,
                    availability: document.getElementById('availability').value,
                    linkedin: document.getElementById('linkedin').value,
                    github: document.getElementById('github').value,
                    portfolio: document.getElementById('portfolio').value,
                    career: document.getElementById('career').value,
                    careerExperience: document.getElementById('career-experience').value,
                    researchPublications: document.getElementById('research-publications').value,
                    awards: document.getElementById('awards').value
                };

                let response;
                if (currentProfile && currentProfile.profileId) {
                    response = await fetch(`/api/profiles/${currentProfile.profileId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(profileData)
                    });
                } else {
                    response = await fetch('/api/profiles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(profileData)
                    });
                }

                if (response.ok) {
                    const savedProfile = await response.json();
                    currentProfile = savedProfile;
                    
                    // Update location status based on geocoding result
                    if (locationValue) {
                        if (savedProfile.latitude && savedProfile.longitude) {
                            statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ Location geocoded successfully!</span>';
                        } else {
                            statusDiv.innerHTML = '<span style="color: #ffc107;">‚ö†Ô∏è Location saved but could not be geocoded. Please use "City, State" format or use "Use My Location" button.</span>';
                        }
                    } else {
                        statusDiv.innerHTML = '';
                    }
                    
                    document.getElementById('profile-message').innerHTML = 
                        '<div class="success-message">Profile saved successfully!</div>';
                    setTimeout(() => {
                        document.getElementById('profile-message').innerHTML = '';
                        if (locationValue && savedProfile.latitude && savedProfile.longitude) {
                            statusDiv.innerHTML = '';
                        }
                    }, 5000);
                    loadProfile();
                } else {
                    const errorText = await response.text();
                    document.getElementById('profile-message').innerHTML = 
                        '<div class="error-message">Error saving profile: ' + errorText + '</div>';
                    if (locationValue) {
                        statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error geocoding location.</span>';
                    }
                }
            } catch (error) {
                document.getElementById('profile-message').innerHTML = 
                    '<div class="error-message">Error: ' + error.message + '</div>';
            }
        });

        async function saveSocialLinks() {
            let user;
            try {
                const usersResponse = await fetch('/api/users');
                const users = await usersResponse.json();
                user = users.find(u => u.userId === currentUserId);
                
                if (!user) {
                    alert('User not found');
                    return;
                }
            } catch (error) {
                alert('Error loading user: ' + error.message);
                return;
            }
            
            const profileData = {
                user: user,
                linkedin: document.getElementById('linkedin').value,
                github: document.getElementById('github').value,
                portfolio: document.getElementById('portfolio').value
            };

            try {
                let response;
                if (currentProfile && currentProfile.profileId) {
                    // Merge with existing profile data
                    profileData.bio = currentProfile.bio || '';
                    profileData.major = currentProfile.major || '';
                    profileData.year = currentProfile.year || '';
                    profileData.location = currentProfile.location || '';
                    profileData.careerGoals = currentProfile.careerGoals || '';
                    profileData.availability = currentProfile.availability || '';
                    
                    response = await fetch(`/api/profiles/${currentProfile.profileId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(profileData)
                    });
                } else {
                    response = await fetch('/api/profiles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(profileData)
                    });
                }

                if (response.ok) {
                    const savedProfile = await response.json();
                    currentProfile = savedProfile;
                    alert('Social links saved successfully!');
                    loadProfile();
                } else {
                    alert('Error saving social links');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showAddSkillForm() {
            document.getElementById('add-skill-form').style.display = 'block';
        }

        function hideAddSkillForm() {
            document.getElementById('add-skill-form').style.display = 'none';
        }

        async function addSkill() {
            const skillData = {
                user: { userId: currentUserId },
                skillName: document.getElementById('new-skill-name').value,
                skillLevel: document.getElementById('new-skill-level').value,
                offering: document.getElementById('offering').checked,
                seeking: document.getElementById('seeking').checked
            };

            try {
                const response = await fetch('/api/user-skills', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(skillData)
                });

                if (response.ok) {
                    loadProfile();
                    hideAddSkillForm();
                    document.getElementById('new-skill-name').value = '';
                }
            } catch (error) {
                console.error('Error adding skill:', error);
            }
        }

        function showAddInterestForm() {
            document.getElementById('add-interest-form').style.display = 'block';
        }

        function hideAddInterestForm() {
            document.getElementById('add-interest-form').style.display = 'none';
        }

        async function addInterest() {
            const interestData = {
                user: { userId: currentUserId },
                interestName: document.getElementById('new-interest-name').value,
                category: document.getElementById('new-interest-category').value
            };

            try {
                const response = await fetch('/api/interests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(interestData)
                });

                if (response.ok) {
                    loadProfile();
                    hideAddInterestForm();
                    document.getElementById('new-interest-name').value = '';
                    document.getElementById('new-interest-category').value = '';
                }
            } catch (error) {
                console.error('Error adding interest:', error);
            }
        }

        function showAddOrgForm() {
            document.getElementById('add-org-form').style.display = 'block';
        }

        function hideAddOrgForm() {
            document.getElementById('add-org-form').style.display = 'none';
        }

        async function addOrganization() {
            const orgData = {
                user: { userId: currentUserId },
                organizationName: document.getElementById('new-org-name').value,
                role: document.getElementById('new-org-role').value
            };

            try {
                const response = await fetch('/api/organizations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orgData)
                });

                if (response.ok) {
                    loadProfile();
                    hideAddOrgForm();
                    document.getElementById('new-org-name').value = '';
                    document.getElementById('new-org-role').value = '';
                }
            } catch (error) {
                console.error('Error adding organization:', error);
            }
        }

        function showAddLanguageForm() {
            document.getElementById('add-language-form').style.display = 'block';
        }

        function hideAddLanguageForm() {
            document.getElementById('add-language-form').style.display = 'none';
        }

        function displayLanguages(languages) {
            const container = document.getElementById('languages-list');
            if (languages.length === 0) {
                container.innerHTML = '<p style="color: #666;">No languages added yet.</p>';
                return;
            }
            container.innerHTML = languages.map(lang => `
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 5px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <div><strong>${lang.languageName}</strong>${lang.proficiencyLevel ? ' - ' + lang.proficiencyLevel : ''}</div>
                    <button onclick="deleteLanguage(${lang.languageId})" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 3px; cursor: pointer;">Delete</button>
                </div>
            `).join('');
        }

        async function addLanguage() {
            const languageName = document.getElementById('new-language-name').value;
            const proficiencyLevel = document.getElementById('new-language-level').value;

            if (!languageName) {
                alert('Please select a language');
                return;
            }

            try {
                const languageData = {
                    user: { userId: currentUserId },
                    languageName: languageName,
                    proficiencyLevel: proficiencyLevel
                };

                const response = await fetch('/api/languages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(languageData)
                });

                if (response.ok) {
                    document.getElementById('new-language-name').value = '';
                    document.getElementById('new-language-level').value = 'Native';
                    hideAddLanguageForm();
                    loadProfile();
                } else {
                    alert('Error adding language');
                }
            } catch (error) {
                console.error('Error adding language:', error);
                alert('Error adding language: ' + error.message);
            }
        }

        async function deleteLanguage(languageId) {
            if (confirm('Are you sure you want to delete this language?')) {
                try {
                    await fetch(`/api/languages/${languageId}`, { method: 'DELETE' });
                    loadProfile();
                } catch (error) {
                    console.error('Error deleting language:', error);
                }
            }
        }

        async function deleteSkill(skillId) {
            if (confirm('Delete this skill?')) {
                try {
                    await fetch(`/api/user-skills/${skillId}`, { method: 'DELETE' });
                    loadProfile();
                } catch (error) {
                    console.error('Error deleting skill:', error);
                }
            }
        }

        async function deleteInterest(interestId) {
            if (confirm('Delete this interest?')) {
                try {
                    await fetch(`/api/interests/${interestId}`, { method: 'DELETE' });
                    loadProfile();
                } catch (error) {
                    console.error('Error deleting interest:', error);
                }
            }
        }

        async function deleteOrganization(orgId) {
            if (confirm('Delete this organization?')) {
                try {
                    await fetch(`/api/organizations/${orgId}`, { method: 'DELETE' });
                    loadProfile();
                } catch (error) {
                    console.error('Error deleting organization:', error);
                }
            }
        }

        function usePreciseLocation() {
            const statusDiv = document.getElementById('location-status');
            statusDiv.innerHTML = '<span style="color: #667eea;">üìç Getting your location...</span>';
            
            if (!navigator.geolocation) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">Geolocation is not supported by your browser.</span>';
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = position.coords.accuracy; // Accuracy in meters
                    
                    // Debug: Log coordinates to verify they're correct
                    console.log('Browser geolocation coordinates:', { latitude: lat, longitude: lon, accuracy: accuracy });
                    
                    // Display location details immediately
                    let locationInfo = `
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-top: 0.5rem; border: 1px solid #dee2e6;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #28a745;">üìç Location Detected</div>
                            <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
                                <strong>Coordinates:</strong> ${lon.toFixed(6)}, ${lat.toFixed(6)}
                            </div>
                            <div style="font-size: 0.9rem; margin-bottom: 0.5rem; color: #666;">
                                <strong>Accuracy:</strong> ¬±${Math.round(accuracy)} meters
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                                <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" 
                                   style="color: #667eea; text-decoration: none;">
                                    üó∫Ô∏è View on Google Maps
                                </a>
                            </div>
                            <div style="font-size: 0.85rem; color: #666;">
                                <em>Reverse geocoding address...</em>
                            </div>
                        </div>
                    `;
                    statusDiv.innerHTML = locationInfo;
                    
                    try {
                        // Reverse geocode to get detailed address
                        const reverseGeocodeUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
                        console.log('=== REVERSE GEOCODING ===');
                        console.log('Request URL:', reverseGeocodeUrl);
                        console.log('Coordinates used for reverse geocoding:', { latitude: lat, longitude: lon });
                        
                        const response = await fetch(reverseGeocodeUrl, {
                            headers: {
                                'User-Agent': 'SkillSwap/1.0'
                            }
                        });
                        const data = await response.json();
                        console.log('Reverse geocoding response:', data);
                        console.log('Full address object:', data.address);
                        
                        // Build detailed address
                        let cityName = '';
                        let fullAddress = '';
                        if (data.address) {
                            const addr = data.address;
                            
                            // Build city name (City, State format)
                            const city = addr.city || addr.town || addr.village || addr.municipality || '';
                            const state = addr.state || '';
                            const stateCode = addr.state_code || '';
                            
                            if (city && (state || stateCode)) {
                                cityName = `${city}, ${stateCode || state}`;
                            } else if (city) {
                                cityName = city;
                            } else if (state) {
                                cityName = state;
                            }
                            
                            // Build full address for verification
                            const addressParts = [];
                            if (addr.house_number) addressParts.push(addr.house_number);
                            if (addr.road) addressParts.push(addr.road);
                            if (city) addressParts.push(city);
                            if (stateCode || state) addressParts.push(stateCode || state);
                            if (addr.postcode) addressParts.push(addr.postcode);
                            if (addr.country) addressParts.push(addr.country);
                            
                            fullAddress = addressParts.join(', ');
                        }
                        
                        // Update location field
                        document.getElementById('location').value = cityName || `${lon.toFixed(4)}, ${lat.toFixed(4)}`;
                        console.log('City name extracted:', cityName);
                        console.log('Full address:', fullAddress);
                        console.log('Location field value set to:', document.getElementById('location').value);
                        
                        // Update display with full address
                        locationInfo = `
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-top: 0.5rem; border: 1px solid #dee2e6;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #28a745;">‚úÖ Location Verified</div>
                                <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
                                    <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}
                                </div>
                                <div style="font-size: 0.9rem; margin-bottom: 0.25rem; color: #666;">
                                    <strong>Accuracy:</strong> ¬±${Math.round(accuracy)} meters
                                </div>
                                ${fullAddress ? `
                                <div style="font-size: 0.9rem; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 3px;">
                                    <strong>Address:</strong><br>
                                    ${fullAddress}
                                </div>
                                ` : ''}
                                <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                    <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" 
                                       style="color: #667eea; text-decoration: none; margin-right: 1rem;">
                                        üó∫Ô∏è View on Google Maps
                                    </a>
                                    <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}&zoom=15" target="_blank" 
                                       style="color: #667eea; text-decoration: none;">
                                        üó∫Ô∏è View on OpenStreetMap
                                    </a>
                                </div>
                                <div style="font-size: 0.85rem; color: #666; font-style: italic;">
                                    Saving location...
                                </div>
                            </div>
                        `;
                        statusDiv.innerHTML = locationInfo;
                        
                        // Update both User and Profile with coordinates
                        const showLocation = document.getElementById('showLocation').checked;
                        
                        console.log('=== PREPARING TO SAVE LOCATION ===');
                        console.log('Current User ID:', currentUserId);
                        console.log('Current Profile ID:', currentProfile?.profileId);
                        console.log('Show Location checkbox:', showLocation);
                        console.log('Coordinates to save:', { latitude: lat, longitude: lon });
                        console.log('Location text:', cityName || document.getElementById('location').value);
                        
                        const locationData = {
                            latitude: lat,
                            longitude: lon,
                            location: cityName || document.getElementById('location').value,
                            showLocation: showLocation
                        };
                        
                        // Update User table location
                        const userLocationData = {
                            latitude: lat,
                            longitude: lon,
                            showLocation: showLocation
                        };
                        
                        console.log('=== SENDING TO BACKEND ===');
                        console.log('User location data being sent:', JSON.stringify(userLocationData, null, 2));
                        console.log('Profile location data being sent:', JSON.stringify(locationData, null, 2));
                        
                        try {
                            // Update user location
                            console.log('Making PUT request to:', `/api/users/${currentUserId}/location`);
                            const userUpdateResponse = await fetch(`/api/users/${currentUserId}/location`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(userLocationData)
                            });
                            console.log('User update response status:', userUpdateResponse.status);
                            const userUpdateResult = await userUpdateResponse.json();
                            console.log('User update response data:', userUpdateResult);
                            
                            // Update profile location if profile exists
                            if (currentProfile && currentProfile.profileId) {
                                console.log('Making PUT request to:', `/api/profiles/${currentProfile.profileId}/location`);
                                const profileUpdateResponse = await fetch(`/api/profiles/${currentProfile.profileId}/location`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(locationData)
                                });
                                console.log('Profile update response status:', profileUpdateResponse.status);
                                const profileUpdateResult = await profileUpdateResponse.json();
                                console.log('Profile update response data:', profileUpdateResult);
                                
                                if (profileUpdateResponse.ok && userUpdateResponse.ok) {
                                    console.log('=== VERIFYING SAVED COORDINATES ===');
                                    // Verify saved coordinates match what we sent
                                    const verifyProfileResponse = await fetch(`/api/profiles/${currentProfile.profileId}`);
                                    const verifyUserResponse = await fetch(`/api/users/${currentUserId}`);
                                    const verifiedProfile = await verifyProfileResponse.json();
                                    const verifiedUser = await verifyUserResponse.json();
                                    
                                    console.log('=== COORDINATE VERIFICATION ===');
                                    console.log('Original coordinates from browser:', { latitude: lat, longitude: lon });
                                    console.log('Coordinates sent to backend:', { latitude: lat, longitude: lon });
                                    console.log('Coordinates saved in Profile table:', { 
                                        latitude: verifiedProfile.latitude, 
                                        longitude: verifiedProfile.longitude,
                                        showLocation: verifiedProfile.showLocation,
                                        location: verifiedProfile.location
                                    });
                                    console.log('Coordinates saved in User table:', { 
                                        latitude: verifiedUser.latitude, 
                                        longitude: verifiedUser.longitude,
                                        showLocation: verifiedUser.showLocation
                                    });
                                    
                                    // Check for mismatches
                                    const profileMatch = verifiedProfile.latitude === lat && verifiedProfile.longitude === lon;
                                    const userMatch = verifiedUser.latitude === lat && verifiedUser.longitude === lon;
                                    console.log('Profile coordinates match:', profileMatch);
                                    console.log('User coordinates match:', userMatch);
                                    
                                    if (!profileMatch || !userMatch) {
                                        console.error('‚ö†Ô∏è COORDINATE MISMATCH DETECTED!');
                                        console.error('Expected:', { latitude: lat, longitude: lon });
                                        console.error('Profile has:', { latitude: verifiedProfile.latitude, longitude: verifiedProfile.longitude });
                                        console.error('User has:', { latitude: verifiedUser.latitude, longitude: verifiedUser.longitude });
                                    }
                                    
                                    locationInfo = `
                                        <div style="background: #d4edda; padding: 1rem; border-radius: 5px; margin-top: 0.5rem; border: 1px solid #c3e6cb;">
                                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #155724;">‚úÖ Location Saved Successfully</div>
                                            <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
                                                <strong>Coordinates (Lat, Lon):</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}
                                            </div>
                                            <div style="font-size: 0.85rem; margin-bottom: 0.25rem; color: #666;">
                                                <strong>Saved in Profile:</strong> Lat ${verifiedProfile.latitude?.toFixed(6) || 'N/A'}, Lon ${verifiedProfile.longitude?.toFixed(6) || 'N/A'}<br>
                                                <strong>Saved in User:</strong> Lat ${verifiedUser.latitude?.toFixed(6) || 'N/A'}, Lon ${verifiedUser.longitude?.toFixed(6) || 'N/A'}
                                            </div>
                                            ${fullAddress ? `
                                            <div style="font-size: 0.9rem; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 3px;">
                                                <strong>Address:</strong><br>
                                                ${fullAddress}
                                            </div>
                                            ` : ''}
                                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                                <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" 
                                                   style="color: #155724; text-decoration: none; margin-right: 1rem;">
                                                    üó∫Ô∏è View on Google Maps
                                                </a>
                                                <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}&zoom=15" target="_blank" 
                                                   style="color: #155724; text-decoration: none;">
                                                    üó∫Ô∏è View on OpenStreetMap
                                                </a>
                                            </div>
                                            <div style="font-size: 0.85rem; color: #155724;">
                                                Location saved to your profile. You can verify it's correct using the map links above.
                                            </div>
                                        </div>
                                    `;
                                    statusDiv.innerHTML = locationInfo;
                                    setTimeout(() => {
                                        loadProfile();
                                    }, 2000);
                                } else {
                                    statusDiv.innerHTML = '<span style="color: #dc3545;">Error updating location.</span>';
                                }
                            } else if (userUpdateResponse.ok) {
                                locationInfo = `
                                    <div style="background: #d4edda; padding: 1rem; border-radius: 5px; margin-top: 0.5rem; border: 1px solid #c3e6cb;">
                                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: #155724;">‚úÖ Location Saved</div>
                                        <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
                                            <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}
                                        </div>
                                        ${fullAddress ? `
                                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 3px;">
                                            <strong>Address:</strong><br>
                                            ${fullAddress}
                                        </div>
                                        ` : ''}
                                        <div style="font-size: 0.85rem;">
                                            <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" 
                                               style="color: #155724; text-decoration: none;">
                                                üó∫Ô∏è Verify on Google Maps
                                            </a>
                                        </div>
                                    </div>
                                `;
                                statusDiv.innerHTML = locationInfo;
                            } else {
                                statusDiv.innerHTML = '<span style="color: #dc3545;">Error updating location.</span>';
                            }
                        } catch (error) {
                            console.error('Error updating location:', error);
                            statusDiv.innerHTML = '<span style="color: #dc3545;">Error updating location: ' + error.message + '</span>';
                        }
                    } catch (error) {
                        console.error('Error reverse geocoding:', error);
                        statusDiv.innerHTML = `
                            <div style="background: #fff3cd; padding: 1rem; border-radius: 5px; margin-top: 0.5rem; border: 1px solid #ffc107;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #856404;">‚ö†Ô∏è Coordinates Saved</div>
                                <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
                                    <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}
                                </div>
                                <div style="font-size: 0.9rem; margin-bottom: 0.5rem; color: #856404;">
                                    Could not get address name, but coordinates were saved. You can verify the location using the map link below.
                                </div>
                                <div style="font-size: 0.85rem;">
                                    <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" 
                                       style="color: #856404; text-decoration: none;">
                                        üó∫Ô∏è View on Google Maps
                                    </a>
                                </div>
                            </div>
                        `;
                    }
                },
                (error) => {
                    let errorMsg = 'Error getting location: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Permission denied. Please enable location access.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Location unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Request timeout.';
                            break;
                        default:
                            errorMsg += 'Unknown error.';
                            break;
                    }
                    statusDiv.innerHTML = `<span style="color: #dc3545;">${errorMsg}</span>`;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        function updateLocationStatus(profile) {
            const statusDiv = document.getElementById('location-status');
            if (profile.latitude && profile.longitude) {
                const lat = profile.latitude;
                const lon = profile.longitude;
                statusDiv.innerHTML = `
                    <div style="background: #e7f3ff; padding: 0.75rem; border-radius: 5px; margin-top: 0.5rem; border: 1px solid #b3d9ff;">
                        <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
                            <strong>‚úÖ Location Set:</strong> ${lon.toFixed(6)}, ${lat.toFixed(6)}
                        </div>
                        <div style="font-size: 0.85rem;">
                            <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" 
                               style="color: #0066cc; text-decoration: none; margin-right: 1rem;">
                                üó∫Ô∏è Verify on Google Maps
                            </a>
                            <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}&zoom=15" target="_blank" 
                               style="color: #0066cc; text-decoration: none;">
                                üó∫Ô∏è Verify on OpenStreetMap
                            </a>
                        </div>
                    </div>
                `;
            } else if (profile.location) {
                statusDiv.innerHTML = `<span style="color: #ffc107;">‚ö†Ô∏è Location text set but coordinates not found. Try using "Use My Location" button.</span>`;
            } else {
                statusDiv.innerHTML = '';
            }
        }

        // Autocomplete functionality
        let locationSuggestionsTimeout = null;
        let isSelectingSuggestion = false;
        let currentSuggestionIndex = -1;
        let currentSuggestions = [];

        async function handleLocationInput() {
            const input = document.getElementById('location');
            const query = input.value.trim();
            const suggestionsDiv = document.getElementById('location-suggestions');

            // Clear previous timeout
            if (locationSuggestionsTimeout) {
                clearTimeout(locationSuggestionsTimeout);
            }

            // Reset suggestion index
            currentSuggestionIndex = -1;

            // Hide suggestions if input is too short
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                currentSuggestions = [];
                return;
            }

            // Debounce the API call
            locationSuggestionsTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/profiles/cities/suggestions?q=${encodeURIComponent(query)}`);
                    if (response.ok) {
                        const suggestions = await response.json();
                        currentSuggestions = suggestions;
                        displayLocationSuggestions(suggestions);
                    }
                } catch (error) {
                    console.error('Error fetching city suggestions:', error);
                }
            }, 300); // Wait 300ms after user stops typing
        }

        function displayLocationSuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('location-suggestions');
            
            if (suggestions.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            suggestionsDiv.innerHTML = suggestions.map((suggestion, index) => {
                const isSelected = index === currentSuggestionIndex;
                return `
                <div class="location-suggestion-item" 
                     data-index="${index}"
                     onclick="selectLocationSuggestion('${suggestion.replace(/'/g, "\\'")}')"
                     onmouseover="highlightSuggestion(${index})"
                     onmouseout="updateSuggestionHighlight()"
                     style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid #eee; 
                            transition: background-color 0.2s; background-color: ${isSelected ? '#f0f0f0' : 'white'};">
                    <span style="color: #333;">üìç ${suggestion}</span>
                </div>
            `;
            }).join('');

            suggestionsDiv.style.display = 'block';
        }

        function highlightSuggestion(index) {
            currentSuggestionIndex = index;
            updateSuggestionHighlight();
        }

        function updateSuggestionHighlight() {
            const items = document.querySelectorAll('.location-suggestion-item');
            items.forEach((item, index) => {
                if (index === currentSuggestionIndex) {
                    item.style.backgroundColor = '#f0f0f0';
                } else {
                    item.style.backgroundColor = 'white';
                }
            });
        }

        function selectLocationSuggestion(suggestion) {
            isSelectingSuggestion = true;
            const input = document.getElementById('location');
            input.value = suggestion;
            document.getElementById('location-suggestions').style.display = 'none';
            currentSuggestionIndex = -1;
            currentSuggestions = [];
            
            // Trigger geocoding status update
            const statusDiv = document.getElementById('location-status');
            statusDiv.innerHTML = '<span style="color: #667eea;">üìç Location selected. Save profile to geocode.</span>';
            
            setTimeout(() => {
                isSelectingSuggestion = false;
            }, 200);
        }

        function handleLocationKeyDown(event) {
            const suggestionsDiv = document.getElementById('location-suggestions');
            
            if (suggestionsDiv.style.display === 'none' || currentSuggestions.length === 0) {
                return;
            }

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                currentSuggestionIndex = Math.min(currentSuggestionIndex + 1, currentSuggestions.length - 1);
                updateSuggestionHighlight();
                scrollToSuggestion();
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                currentSuggestionIndex = Math.max(currentSuggestionIndex - 1, -1);
                updateSuggestionHighlight();
                scrollToSuggestion();
            } else if (event.key === 'Enter' && currentSuggestionIndex >= 0) {
                event.preventDefault();
                selectLocationSuggestion(currentSuggestions[currentSuggestionIndex]);
            } else if (event.key === 'Escape') {
                suggestionsDiv.style.display = 'none';
                currentSuggestionIndex = -1;
            }
        }

        function scrollToSuggestion() {
            if (currentSuggestionIndex >= 0) {
                const items = document.querySelectorAll('.location-suggestion-item');
                if (items[currentSuggestionIndex]) {
                    items[currentSuggestionIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }
        }

        function handleLocationFocus() {
            const input = document.getElementById('location');
            if (input.value.trim().length >= 2) {
                handleLocationInput();
            }
        }

        function handleLocationBlur() {
            // Delay hiding suggestions to allow click events to fire
            setTimeout(() => {
                if (!isSelectingSuggestion) {
                    document.getElementById('location-suggestions').style.display = 'none';
                    currentSuggestionIndex = -1;
                }
            }, 200);
        }

        loadProfile();
    </script>
</body>
</html>
